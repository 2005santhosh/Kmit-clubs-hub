<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - KMIT Clubs Hub</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables - Same as dashboard */
        :root {
            --primary: #003366;
            --primary-dark: #002244;
            --secondary: #f8fafc;
            --accent: #ffc107;
            --accent-light: #ffcd39;
            --text: #212529;
            --light-text: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --gradient-primary: linear-gradient(135deg, #003366 0%, #0055a4 100%);
            --gradient-accent: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
            --danger: #dc3545;
        }

        /* Global Styles - Same as dashboard */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lato', sans-serif;
            line-height: 1.7;
            color: var(--text);
            background-color: #fff;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Typography - Same as dashboard */
        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            margin-bottom: 1.2rem;
            font-weight: 600;
            line-height: 1.2;
        }

        h1 {
            font-size: 2.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        h3 {
            font-size: 1.5rem;
            margin-bottom: 0.8rem;
            color: var(--primary);
        }

        p {
            margin-bottom: 1.2rem;
            color: var(--light-text);
            font-weight: 300;
        }

        a {
            text-decoration: none;
            color: var(--primary);
            transition: var(--transition);
        }

        a:hover {
            color: var(--accent);
        }

        /* Dashboard Layout - Same as dashboard */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Same as dashboard */
        .sidebar {
            width: 260px;
            background: var(--gradient-primary);
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 0 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 1.5rem;
            background: none;
            -webkit-text-fill-color: initial;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 0.8rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            transition: var(--transition);
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-menu i {
            margin-right: 0.8rem;
            font-size: 1.2rem;
        }

        .user-profile {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: 600;
        }

        .user-info h4 {
            color: white;
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }

        .user-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin: 0;
        }

        /* Main Content - Same as dashboard */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            background-color: #f8fafc;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title h1 {
            margin-bottom: 0.5rem;
        }

        .dashboard-actions {
            display: flex;
            gap: 1rem;
        }

        .notification-icon {
            position: relative;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--accent);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Buttons - Same as dashboard */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 51, 102, 0.4);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: #ffc107;
            color: var(--primary-dark);
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* Content Sections - Same as dashboard */
        .content-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin: 0;
        }

        /* Mobile Menu Toggle - Same as dashboard */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--box-shadow);
        }

        /* Loading Spinner - Same as dashboard */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message - Same as dashboard */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        /* Success Message */
        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        /* Reports Specific Styles */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-card {
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .report-icon {
            height: 120px;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 3rem;
        }

        .report-content {
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .report-title {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .report-description {
            color: var(--light-text);
            margin-bottom: 1rem;
            flex: 1;
        }

        .report-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .report-date {
            color: var(--light-text);
            font-size: 0.9rem;
        }

        .report-actions {
            display: flex;
            gap: 0.5rem;
        }

        .report-actions .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .report-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .filter-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
        }

        .filter-control:focus {
            border-color: var(--primary);
        }

        .report-preview {
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .report-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .report-preview-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin: 0;
        }

        .report-preview-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .report-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .report-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .report-chart-container {
            height: 300px;
            position: relative;
        }

        .custom-report-form {
            display: none;
            background-color: var(--secondary);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        /* Report Mode Toggle */
        .report-mode-toggle {
            display: flex;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--primary);
        }

        .report-mode-toggle button {
            flex: 1;
            padding: 10px 15px;
            background-color: white;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .report-mode-toggle button.active {
            background-color: var(--primary);
            color: white;
        }

        /* File Upload Styles */
        .file-upload-container {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .file-upload-container:hover {
            border-color: var(--primary);
        }

        .file-upload-container.drag-over {
            background-color: rgba(0, 51, 102, 0.05);
            border-color: var(--primary);
        }

        .file-upload-icon {
            font-size: 3rem;
            color: var(--light-text);
            margin-bottom: 1rem;
        }

        .file-upload-text {
            color: var(--light-text);
            margin-bottom: 1rem;
        }

        .file-upload-input {
            display: none;
        }

        .file-upload-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-upload-label:hover {
            background-color: var(--primary-dark);
        }

        .file-info {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .file-info-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-right: 1rem;
        }

        .file-info-details {
            flex: 1;
        }

        .file-info-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .file-info-size {
            font-size: 0.85rem;
            color: var(--light-text);
        }

        .file-info-remove {
            color: var(--danger);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Uploaded Reports Indicator */
        .uploaded-report {
            border-left-color: var(--accent);
        }

        .report-file-type {
            font-size: 0.8rem;
            color: var(--light-text);
            margin-bottom: 0.5rem;
        }

        /* Confirmation Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confirm-dialog-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--box-shadow);
        }

        .confirm-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .confirm-dialog-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin: 0;
        }

        .confirm-dialog-body {
            margin-bottom: 1.5rem;
            color: var(--light-text);
        }

        .confirm-dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Responsive Styles - Same as dashboard */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
        }

        @media (max-width: 576px) {
            h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .report-filters {
                flex-direction: column;
            }
            
            .report-preview-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-university"></i> KMIT Clubs Hub</h2>
            </div>
            <ul class="sidebar-menu">
               <li><a href="/club_leader_dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="/leader-user-management"><i class="fas fa-users"></i> Manage Members</a></li>
                <li><a href="/leader-events"><i class="fas fa-calendar-alt"></i> Events</a></li>
                <li><a href="/leader-reports" class="active"><i class="fas fa-file-alt"></i> Reports</a></li>
                <li><a href="/leader-analytics"><i class="fas fa-chart-line"></i> Analytics</a></li>
                <li><a href="/leader-settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">RK</div>
                <div class="user-info">
                    <h4 id="userName">Rahul Kumar</h4>
                    <p id="userRole">Club Leader - Recurse</p>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="dashboard-title">
                    <h1>Club Reports</h1>
                    <p>Generate and view club activity reports</p>
                </div>
                <div class="dashboard-actions">
                    <div class="notification-icon">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">2</span>
                    </div>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="spinner" style="display: none;"></div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <!-- Success Message -->
            <div id="successMessage" class="success-message" style="display: none;"></div>

            <!-- Create or Upload Report -->
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Reports</h3>
                    <button class="btn btn-primary" onclick="toggleReportForm()">
                        <i class="fas fa-plus"></i> New Report
                    </button>
                </div>

                <!-- Report Mode Toggle -->
                <div class="report-mode-toggle" id="reportModeToggle" style="display: none;">
                    <button id="generateReportBtn" class="active" onclick="switchReportMode('generate')">
                        <i class="fas fa-file-alt"></i> Generate Report
                    </button>
                    <button id="uploadReportBtn" onclick="switchReportMode('upload')">
                        <i class="fas fa-file-upload"></i> Upload Report
                    </button>
                </div>

                <!-- Generate Report Form -->
                <div class="custom-report-form" id="generateReportForm">
                    <h3>Generate Custom Report</h3>
                    <form id="newReportForm">
                        <div class="form-group">
                            <label for="reportName">Report Name</label>
                            <input type="text" id="reportName" class="form-control" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reportType">Report Type</label>
                                <select id="reportType" class="form-control" required>
                                    <option value="">Select Type</option>
                                    <option value="users">Users Report</option>
                                    <option value="clubs">Clubs Report</option>
                                    <option value="events">Events Report</option>
                                    <option value="attendance">Attendance Report</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="reportFormat">Format</label>
                                <select id="reportFormat" class="form-control" required>
                                    <option value="pdf">PDF</option>
                                    <option value="excel">Excel</option>
                                    <option value="csv">CSV</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="startDate">Start Date</label>
                                <input type="date" id="startDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Include Data</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="includeMembers" checked>
                                    <label for="includeMembers">Members</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="includeEvents" checked>
                                    <label for="includeEvents">Events</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="includeAttendance">
                                    <label for="includeAttendance">Attendance</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="includeFinances">
                                    <label for="includeFinances">Finances</label>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">Generate Report</button>
                            <button type="button" class="btn btn-secondary" onclick="toggleReportForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Upload Report Form -->
                <div class="custom-report-form" id="uploadReportForm">
                    <h3>Upload Report</h3>
                    <form id="uploadReportFormElement">
                        <div class="form-group">
                            <label for="uploadReportTitle">Report Title</label>
                            <input type="text" id="uploadReportTitle" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="uploadReportDescription">Description</label>
                            <textarea id="uploadReportDescription" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="uploadReportType">Report Type</label>
                                <select id="uploadReportType" class="form-control" required>
                                    <option value="">Select Type</option>
                                    <option value="event">Event Report</option>
                                    <option value="monthly">Monthly Report</option>
                                    <option value="annual">Annual Report</option>
                                    <option value="financial">Financial Report</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="uploadReportFormat">Format</label>
                                <select id="uploadReportFormat" class="form-control" required>
                                    <option value="pdf">PDF</option>
                                    <option value="excel">Excel</option>
                                    <option value="csv">CSV</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Upload File</label>
                            <div class="file-upload-container" id="fileUploadContainer">
                                <div class="file-upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <p class="file-upload-text">Drag and drop your report file here or click to browse</p>
                                <input type="file" id="uploadReportFile" class="file-upload-input" accept=".pdf,.xlsx,.xls,.csv" required>
                                <label for="uploadReportFile" class="file-upload-label">Choose File</label>
                            </div>
                            <div id="fileInfo" style="display: none;"></div>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">Upload Report</button>
                            <button type="button" class="btn btn-secondary" onclick="toggleReportForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Report Filters -->
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Filter Reports</h3>
                </div>
                <div class="report-filters">
                    <div class="filter-group">
                        <label for="reportTypeFilter">Report Type</label>
                        <select id="reportTypeFilter" class="filter-control" onchange="filterReports()">
                            <option value="all">All Types</option>
                            <option value="users">Users Report</option>
                            <option value="clubs">Clubs Report</option>
                            <option value="events">Events Report</option>
                            <option value="attendance">Attendance Report</option>
                            <option value="activity">Activity Report</option>
                            <option value="feedback">Feedback Report</option>
                            <option value="event">Event Report</option>
                            <option value="monthly">Monthly Report</option>
                            <option value="annual">Annual Report</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dateRangeFilter">Date Range</label>
                        <select id="dateRangeFilter" class="filter-control" onchange="filterReports()">
                            <option value="all">All Time</option>
                            <option value="last-week">Last Week</option>
                            <option value="last-month">Last Month</option>
                            <option value="last-quarter">Last Quarter</option>
                            <option value="last-year">Last Year</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchFilter">Search</label>
                        <input type="text" id="searchFilter" class="filter-control" placeholder="Search reports..." onkeyup="filterReports()">
                    </div>
                </div>
            </div>

            <!-- Reports Grid -->
            <div class="content-section">
                <div class="section-header">
                    <h3 class="section-title">Available Reports</h3>
                    <div class="view-toggle">
                        <button class="btn btn-secondary" id="gridViewBtn" onclick="toggleView('grid')">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="btn btn-secondary" id="listViewBtn" onclick="toggleView('list')">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Grid View -->
                <div id="reportsGridView" class="reports-grid">
                    <div class="spinner"></div>
                </div>
                
                <!-- List View -->
                <div id="reportsListView" style="display: none;">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Report Preview -->
            <div class="content-section" id="reportPreviewSection" style="display: none;">
                <div class="report-preview">
                    <div class="report-preview-header">
                        <h3 class="report-preview-title" id="previewTitle">Report Preview</h3>
                        <div>
                            <button class="btn btn-primary" onclick="downloadReport()">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-secondary" onclick="closeReportPreview()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                    <div class="report-preview-content" id="reportPreviewContent">
                        <!-- Report preview will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // API base URL
        const API_URL = '/api';
        let clubId = '';
        let allReports = [];
        let filteredReports = [];
        let currentView = 'grid';
        let currentReport = null;
        let currentReportMode = 'generate'; // 'generate' or 'upload'
        let selectedFile = null;

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            // Check for token in localStorage
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Set up axios default headers
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            
            // Initialize page
            initializePage();
            
            // Set up mobile menu toggle
            setupMobileMenu();
            
            // Set up form submission
            document.getElementById('newReportForm').addEventListener('submit', handleGenerateReport);
            document.getElementById('uploadReportFormElement').addEventListener('submit', handleUploadReport);
            
            // Set up file upload
            setupFileUpload();
        });

        // Initialize page with data fetching
        async function initializePage() {
            try {
                showLoading(true);
                hideError();
                hideSuccess();
                
                // Fetch user data
                const userData = await fetchUserData();
                updateUserInterface(userData);
                clubId = userData.club._id;
                
                // Fetch club reports
                await fetchClubReports(clubId);
                
                // Render reports grid
                renderReportsGrid();
                
            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Failed to load reports data. Please try again later.');
                
                // If unauthorized, redirect to login
                if (error.response && error.response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                }
            } finally {
                showLoading(false);
            }
        }

        // Show/hide loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.style.display = show ? 'block' : 'none';
            }
        }

        // Show/hide error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        // Show/hide success message
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
                
                // Auto hide after 3 seconds
                setTimeout(() => {
                    hideSuccess();
                }, 3000);
            }
        }

        function hideSuccess() {
            const successElement = document.getElementById('successMessage');
            if (successElement) {
                successElement.style.display = 'none';
            }
        }

        // Fetch user data
        async function fetchUserData() {
            const response = await axios.get(`${API_URL}/auth/me`);
            return response.data;
        }

        // Fetch club reports from both collections
        async function fetchClubReports(clubId) {
            try {
                // Fetch generated reports from clubactivityreports
                const generatedResponse = await axios.get(`${API_URL}/clubactivityreports/club/${clubId}`);
                const generatedReports = (generatedResponse.data || []).map(report => ({
                    ...report,
                    createdAt: report.createdAt || report.submittedDate,
                    attachments: report.attachments || [],
                    collection: 'clubactivityreports'
                }));

                // Fetch uploaded reports from reports
                const uploadedResponse = await axios.get(`${API_URL}/reports/club/${clubId}`);
                const uploadedReports = (uploadedResponse.data || []).map(report => ({
                    ...report,
                    createdAt: report.createdAt || report.submittedDate,
                    attachments: report.attachments || [],
                    collection: 'reports'
                }));

                // Combine both arrays and remove duplicates by _id
                const combinedReports = [...generatedReports, ...uploadedReports];
                const uniqueReportsMap = new Map();
                
                combinedReports.forEach(report => {
                    uniqueReportsMap.set(report._id.toString(), report);
                });
                
                allReports = Array.from(uniqueReportsMap.values());
                filteredReports = [...allReports];
            } catch (error) {
                console.error('Error fetching club reports:', error);
                allReports = [];
                filteredReports = [];
                throw error;
            }
        }

        // Update user interface with user data
        function updateUserInterface(userData) {
            // Update user profile in sidebar
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            if (userAvatar) {
                userAvatar.textContent = userData.name.split(' ').map(n => n[0]).join('');
            }
            
            if (userName) {
                userName.textContent = userData.name;
            }
            
            if (userRole) {
                userRole.textContent = `Club Leader - ${userData.club ? userData.club.name : 'No Club'}`;
            }
        }

        // Render reports grid
        function renderReportsGrid() {
            const reportsGrid = document.getElementById('reportsGridView');
            if (!reportsGrid) return;
            
            // Clear grid
            reportsGrid.innerHTML = '';
            
            if (filteredReports.length === 0) {
                reportsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">No reports found</p>';
                return;
            }
            
            // Add each report to the grid
            filteredReports.forEach(report => {
                const reportDate = new Date(report.createdAt || report.submittedDate).toLocaleDateString();
                const reportIcon = getReportIcon(report);
                const isUploaded = report.attachments && report.attachments.length > 0;
                
                const reportCard = document.createElement('div');
                reportCard.className = `report-card ${isUploaded ? 'uploaded-report' : ''}`;
                reportCard.innerHTML = `
                    <div class="report-icon">
                        <i class="fas ${reportIcon}"></i>
                    </div>
                    <div class="report-content">
                        <h3 class="report-title">${report.title || report.name || 'Untitled Report'}</h3>
                        <p class="report-description">${report.description || 'No description available'}</p>
                        ${isUploaded ? `<p class="report-file-type">File: ${report.attachments[0].filename}</p>` : ''}
                        <div class="report-footer">
                            <div class="report-date">${reportDate}</div>
                            <div class="report-actions">
                                ${isUploaded ? 
                                    `<button class="btn btn-primary" onclick="downloadAttachment('${report._id}')">
                                        <i class="fas fa-download"></i> Download
                                    </button>` :
                                    `<button class="btn btn-primary" onclick="previewReport('${report._id}')">Preview</button>
                                    <button class="btn btn-secondary" onclick="downloadReport('${report._id}')">
                                        <i class="fas fa-download"></i>
                                    </button>`
                                }
                                <button class="btn btn-danger" onclick="confirmDeleteReport('${report._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                reportsGrid.appendChild(reportCard);
            });
        }

        // Render reports list
        function renderReportsList() {
            const reportsList = document.getElementById('reportsListView');
            if (!reportsList) return;
            
            // Clear list
            reportsList.innerHTML = '';
            
            if (filteredReports.length === 0) {
                reportsList.innerHTML = '<p style="text-align: center;">No reports found</p>';
                return;
            }
            
            // Create table
            const table = document.createElement('table');
            table.className = 'report-table';
            
            // Create table header
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Report Name</th>
                    <th>Type</th>
                    <th>Date Created</th>
                    <th>Format</th>
                    <th>Actions</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            // Add each report to the table
            filteredReports.forEach(report => {
                const reportDate = new Date(report.createdAt || report.submittedDate).toLocaleDateString();
                const isUploaded = report.attachments && report.attachments.length > 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.title || report.name || 'Untitled Report'}</td>
                    <td>${formatReportType(report.type)}</td>
                    <td>${reportDate}</td>
                    <td>${report.format || (isUploaded ? report.attachments[0].filename.split('.').pop().toUpperCase() : 'PDF')}</td>
                    <td>
                        <div class="report-actions">
                            ${isUploaded ? 
                                `<button class="btn btn-primary" onclick="downloadAttachment('${report._id}')">
                                    <i class="fas fa-download"></i> Download
                                </button>` :
                                `<button class="btn btn-primary" onclick="previewReport('${report._id}')">Preview</button>
                                <button class="btn btn-secondary" onclick="downloadReport('${report._id}')">
                                    <i class="fas fa-download"></i>
                                </button>`
                            }
                            <button class="btn btn-danger" onclick="confirmDeleteReport('${report._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            reportsList.appendChild(table);
        }

        // Get report icon based on type
        function getReportIcon(report) {
            // If it's an uploaded report (has attachments), use a file icon
            if (report.attachments && report.attachments.length > 0) {
                return 'fa-file-upload';
            }

            // Otherwise, use the type to determine the icon
            switch(report.type) {
                // Report model types
                case 'users': return 'fa-users';
                case 'clubs': return 'fa-university';
                case 'events': return 'fa-calendar-alt';
                case 'attendance': return 'fa-user-check';
                case 'activity': return 'fa-chart-line';
                case 'feedback': return 'fa-comment';
                // ClubActivityReport model types
                case 'event': return 'fa-calendar-alt';
                case 'monthly': 
                case 'annual': 
                    return 'fa-file-alt';
                case 'financial': return 'fa-money-bill-wave';
                default: return 'fa-file-alt';
            }
        }

        // Format report type
        function formatReportType(type) {
            switch(type) {
                // Report model types
                case 'users': return 'Users Report';
                case 'clubs': return 'Clubs Report';
                case 'events': return 'Events Report';
                case 'attendance': return 'Attendance Report';
                case 'activity': return 'Activity Report';
                case 'feedback': return 'Feedback Report';
                // ClubActivityReport model types
                case 'event': return 'Event Report';
                case 'monthly': return 'Monthly Report';
                case 'annual': return 'Annual Report';
                case 'financial': return 'Financial Report';
                default: return 'Other Report';
            }
        }

        // Toggle report form
        function toggleReportForm() {
            const generateForm = document.getElementById('generateReportForm');
            const uploadForm = document.getElementById('uploadReportForm');
            const modeToggle = document.getElementById('reportModeToggle');
            
            if (generateForm.style.display === 'block' || uploadForm.style.display === 'block') {
                generateForm.style.display = 'none';
                uploadForm.style.display = 'none';
                modeToggle.style.display = 'none';
            } else {
                modeToggle.style.display = 'flex';
                switchReportMode(currentReportMode);
            }
        }

        // Switch between generate and upload report modes
        function switchReportMode(mode) {
            currentReportMode = mode;
            const generateForm = document.getElementById('generateReportForm');
            const uploadForm = document.getElementById('uploadReportForm');
            const generateBtn = document.getElementById('generateReportBtn');
            const uploadBtn = document.getElementById('uploadReportBtn');
            
            if (mode === 'generate') {
                generateForm.style.display = 'block';
                uploadForm.style.display = 'none';
                generateBtn.classList.add('active');
                uploadBtn.classList.remove('active');
            } else {
                generateForm.style.display = 'none';
                uploadForm.style.display = 'block';
                generateBtn.classList.remove('active');
                uploadBtn.classList.add('active');
            }
        }

        // Setup file upload functionality
        function setupFileUpload() {
            const fileInput = document.getElementById('uploadReportFile');
            const fileContainer = document.getElementById('fileUploadContainer');
            const fileInfo = document.getElementById('fileInfo');
            
            // Handle file selection via input
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    selectedFile = e.target.files[0];
                    displayFileInfo(selectedFile);
                }
            });
            
            // Handle drag and drop
            fileContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileContainer.classList.add('drag-over');
            });
            
            fileContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileContainer.classList.remove('drag-over');
            });
            
            fileContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                fileContainer.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    selectedFile = e.dataTransfer.files[0];
                    fileInput.files = e.dataTransfer.files;
                    displayFileInfo(selectedFile);
                }
            });
        }

        // Display selected file information
        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            // Validate file type
            const validTypes = ['pdf', 'xlsx', 'xls', 'csv'];
            if (!validTypes.includes(fileExtension)) {
                showError('Invalid file type. Please upload a PDF, Excel, or CSV file.');
                return;
            }
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showError('File size exceeds 5MB limit.');
                return;
            }
            
            // Display file info
            fileInfo.innerHTML = `
                <div class="file-info">
                    <div class="file-info-icon">
                        <i class="fas fa-file-${fileExtension === 'pdf' ? 'pdf' : 'excel'}"></i>
                    </div>
                    <div class="file-info-details">
                        <div class="file-info-name">${file.name}</div>
                        <div class="file-info-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-info-remove" onclick="removeSelectedFile()">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            `;
            fileInfo.style.display = 'block';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Remove selected file
        function removeSelectedFile() {
            selectedFile = null;
            document.getElementById('uploadReportFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
        }

        // Map report types to valid database values
        function mapReportTypeToValidType(reportType) {
            const typeMapping = {
                'membership': 'users',    // Map membership to users
                'financial': 'activity',  // Map financial to activity
                // Other types are already valid
                'users': 'users',
                'clubs': 'clubs',
                'events': 'events',
                'attendance': 'attendance',
                'activity': 'activity',
                'feedback': 'feedback'
            };
            
            return typeMapping[reportType] || reportType;
        }

        // Handle generate report form submission
        async function handleGenerateReport(event) {
            event.preventDefault();
            
            // Get form values
            const reportName = document.getElementById('reportName').value;
            const reportType = document.getElementById('reportType').value;
            const reportFormat = document.getElementById('reportFormat').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Validate required fields
            if (!reportName) {
                showError('Report name is required');
                return;
            }
            
            if (!reportType) {
                showError('Report type is required');
                return;
            }
            
            if (!reportFormat) {
                showError('Report format is required');
                return;
            }
            
            if (!startDate) {
                showError('Start date is required');
                return;
            }
            
            if (!endDate) {
                showError('End date is required');
                return;
            }
            
            // Validate date range
            if (new Date(startDate) > new Date(endDate)) {
                showError('Start date must be before end date');
                return;
            }
            
            try {
                showLoading(true);
                hideError();
                hideSuccess();
                
                // Map report type to valid database value
                const validReportType = mapReportTypeToValidType(reportType);
                
                // Prepare report data with proper structure
                const reportData = {
                    clubId: clubId,
                    name: reportName,
                    type: validReportType,  // Use the mapped type
                    format: reportFormat,
                    dateFrom: startDate,
                    dateTo: endDate,
                    includeMembers: document.getElementById('includeMembers').checked,
                    includeEvents: document.getElementById('includeEvents').checked,
                    includeAttendance: document.getElementById('includeAttendance').checked,
                    includeFinances: document.getElementById('includeFinances').checked
                };
                
                // Ensure all required properties are present and not undefined
                if (!reportData.clubId) {
                    throw new Error('Club ID is required');
                }
                
                // Validate that at least one data type is selected
                if (!reportData.includeMembers && !reportData.includeEvents && 
                    !reportData.includeAttendance && !reportData.includeFinances) {
                    showError('Please select at least one data type to include in the report');
                    return;
                }
                
                console.log('Generating report with data:', reportData);
                console.log('Original type:', reportType, 'Mapped to:', validReportType);
                
                // Try to generate the report using clubactivityreports endpoint
                const response = await axios.post(`${API_URL}/clubactivityreports/generate`, reportData);
                console.log('Report generated successfully:', response.data);
                
                // Check if response contains valid data
                if (!response.data || typeof response.data !== 'object') {
                    throw new Error('Invalid response from server');
                }
                
                // Refresh reports list with real data
                await fetchClubReports(clubId);
                
                // Show success message
                showSuccess('Report generated successfully!');
                
                // Re-render reports
                renderReportsGrid();
                
                // Hide form
                toggleReportForm();
                
            } catch (error) {
                console.error('Error generating report:', error);
                
                // Provide more specific error message
                let errorMessage = 'Failed to generate report. Please try again.';
                
                if (error.response) {
                    // The request was made and the server responded with a status code
                    console.error('Error response data:', error.response.data);
                    console.error('Error response status:', error.response.status);
                    
                    if (error.response.status === 404) {
                        errorMessage = 'Report generation endpoint not found. Please contact support.';
                    } else if (error.response.data && error.response.data.message) {
                        errorMessage = error.response.data.message;
                    } else if (error.response.data && typeof error.response.data === 'string') {
                        errorMessage = error.response.data;
                    }
                } else if (error.request) {
                    // The request was made but no response was received
                    console.error('Error request:', error.request);
                    errorMessage = 'No response from server. Please check your internet connection.';
                } else {
                    // Something happened in setting up the request that triggered an Error
                    console.error('Error message:', error.message);
                    errorMessage = `Error: ${error.message}`;
                }
                
                showError(errorMessage);
            } finally {
                showLoading(false);
            }
        }

        // Handle upload report form submission
        async function handleUploadReport(event) {
            event.preventDefault();
            
            if (!selectedFile) {
                showError('Please select a file to upload.');
                return;
            }
            
            try {
                showLoading(true);
                hideError();
                hideSuccess();
                
                const formData = new FormData();
                formData.append('title', document.getElementById('uploadReportTitle').value);
                formData.append('description', document.getElementById('uploadReportDescription').value);
                formData.append('type', document.getElementById('uploadReportType').value);
                formData.append('format', document.getElementById('uploadReportFormat').value);
                formData.append('club', clubId);
                formData.append('file', selectedFile);
                
                const response = await axios.post(`${API_URL}/upload/report`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                console.log('Report uploaded successfully:', response.data);
                
                // Refresh reports list
                await fetchClubReports(clubId);
                
                // Re-render reports
                renderReportsGrid();
                
                // Show success message
                showSuccess('Report uploaded successfully!');
                
                // Reset form and file selection
                document.getElementById('uploadReportFormElement').reset();
                removeSelectedFile();
                
                // Hide form
                toggleReportForm();
                
            } catch (error) {
                console.error('Error uploading report:', error);
                
                // Provide more specific error message
                let errorMessage = 'Failed to upload report. Please try again.';
                
                if (error.response) {
                    console.error('Error response data:', error.response.data);
                    console.error('Error response status:', error.response.status);
                    
                    if (error.response.status === 404) {
                        errorMessage = 'Report upload endpoint not found. Please contact support.';
                    } else if (error.response.data && error.response.data.message) {
                        errorMessage = error.response.data.message;
                    }
                } else if (error.request) {
                    console.error('Error request:', error.request);
                    errorMessage = 'No response from server. Please check your internet connection.';
                } else {
                    console.error('Error message:', error.message);
                    errorMessage = `Error: ${error.message}`;
                }
                
                showError(errorMessage);
            } finally {
                showLoading(false);
            }
        }

        // Filter reports based on selected criteria
        function filterReports() {
            const typeFilter = document.getElementById('reportTypeFilter').value;
            const dateRangeFilter = document.getElementById('dateRangeFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            filteredReports = allReports.filter(report => {
                // Type filter
                if (typeFilter !== 'all' && report.type !== typeFilter) {
                    return false;
                }
                
                // Date range filter
                if (dateRangeFilter !== 'all') {
                    const reportDate = new Date(report.createdAt || report.submittedDate);
                    const now = new Date();
                    let startDate;
                    
                    switch(dateRangeFilter) {
                        case 'last-week':
                            startDate = new Date(now);
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case 'last-month':
                            startDate = new Date(now);
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                        case 'last-quarter':
                            startDate = new Date(now);
                            startDate.setMonth(now.getMonth() - 3);
                            break;
                        case 'last-year':
                            startDate = new Date(now);
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }
                    
                    if (startDate && reportDate < startDate) {
                        return false;
                    }
                }
                
                // Search filter
                if (searchFilter) {
                    const reportName = (report.title || report.name || '').toLowerCase();
                    const reportDescription = (report.description || '').toLowerCase();
                    
                    if (!reportName.includes(searchFilter) && !reportDescription.includes(searchFilter)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Re-render based on current view
            if (currentView === 'grid') {
                renderReportsGrid();
            } else {
                renderReportsList();
            }
        }

        // Toggle between grid and list view
        function toggleView(view) {
            currentView = view;
            
            const gridView = document.getElementById('reportsGridView');
            const listView = document.getElementById('reportsListView');
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (view === 'grid') {
                gridView.style.display = 'grid';
                listView.style.display = 'none';
                gridBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                gridView.style.display = 'none';
                listView.style.display = 'block';
                gridBtn.classList.remove('active');
                listBtn.classList.add('active');
                renderReportsList();
            }
        }

        // Preview report
        async function previewReport(reportId) {
            try {
                showLoading(true);
                
                // Find the report in the allReports array to get its collection
                const report = allReports.find(r => r._id === reportId);
                if (!report) {
                    throw new Error('Report not found');
                }

                // Determine the endpoint based on the collection
                let endpoint;
                if (report.collection === 'clubactivityreports') {
                    endpoint = `${API_URL}/clubactivityreports/${reportId}`;
                } else {
                    endpoint = `${API_URL}/reports/${reportId}`;
                }
                
                // Fetch report details
                const response = await axios.get(endpoint);
                currentReport = response.data;
                
                // Check if it's an uploaded report
                if (currentReport.attachments && currentReport.attachments.length > 0) {
                    showError('Preview not available for uploaded reports. Please download the file.');
                    return;
                }
                
                // Update preview title
                document.getElementById('previewTitle').textContent = currentReport.name || 'Report Preview';
                
                // Generate preview content based on report type
                const previewContent = document.getElementById('reportPreviewContent');
                previewContent.innerHTML = '';
                
                switch(currentReport.type) {
                    case 'users':
                        previewContent.innerHTML = generateMembershipReportPreview(currentReport);
                        break;
                    case 'clubs':
                        previewContent.innerHTML = generateClubsReportPreview(currentReport);
                        break;
                    case 'events':
                        previewContent.innerHTML = generateEventsReportPreview(currentReport);
                        break;
                    case 'attendance':
                        previewContent.innerHTML = generateAttendanceReportPreview(currentReport);
                        break;
                    case 'activity':
                        previewContent.innerHTML = generateFinancialReportPreview(currentReport);
                        break;
                    default:
                        previewContent.innerHTML = '<p>Report preview not available</p>';
                }
                
                // Show preview section
                document.getElementById('reportPreviewSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching report details:', error);
                showError('Failed to load report preview. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Download attachment for uploaded reports
        async function downloadAttachment(reportId) {
            try {
                showLoading(true);
                
                // Find the report in the allReports array to get its collection
                const report = allReports.find(r => r._id === reportId);
                if (!report) {
                    throw new Error('Report not found');
                }

                // Determine the endpoint based on the collection
                let endpoint;
                if (report.collection === 'clubactivityreports') {
                    endpoint = `${API_URL}/clubactivityreports/${reportId}/attachment`;
                } else {
                    endpoint = `${API_URL}/reports/${reportId}/attachment`;
                }
                
                const response = await axios.get(endpoint, {
                    responseType: 'blob'
                });
                
                // Create a blob URL and trigger download
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                
                // Get filename from Content-Disposition header if available
                const contentDisposition = response.headers['content-disposition'];
                let filename = 'report.pdf';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch && filenameMatch.length === 2) {
                        filename = filenameMatch[1];
                    }
                }
                
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the blob URL
                setTimeout(() => {
                    window.URL.revokeObjectURL(url);
                }, 100);
                
            } catch (error) {
                console.error('Error downloading attachment:', error);
                showError('Failed to download report. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Generate membership report preview (now mapped to users type)
        function generateMembershipReportPreview(report) {
            // Ensure report data exists and is an object
            const data = (report && report.data && typeof report.data === 'object') ? report.data : {};
            
            let html = `
                <h4>Membership Summary</h4>
                <p>Total Members: ${data.totalMembers || 0}</p>
                <p>New Members: ${data.newMembers || 0}</p>
                <p>Active Members: ${data.activeMembers || 0}</p>
                <p>Inactive Members: ${data.inactiveMembers || 0}</p>
            `;
            
            // Check if membersByRole exists and is an object
            if (data.membersByRole && typeof data.membersByRole === 'object' && Object.keys(data.membersByRole).length > 0) {
                html += `
                    <h4>Members by Role</h4>
                    <div class="report-chart-container">
                        <canvas id="membersByRoleChart"></canvas>
                    </div>
                `;
                
                // Create chart after DOM update
                setTimeout(() => {
                    createMembersByRoleChart(data.membersByRole);
                }, 100);
            }
            
            // Check if membershipTrend exists and is an array
            if (data.membershipTrend && Array.isArray(data.membershipTrend) && data.membershipTrend.length > 0) {
                html += `
                    <h4>Membership Trend</h4>
                    <div class="report-chart-container">
                        <canvas id="membershipTrendChart"></canvas>
                    </div>
                `;
                
                // Create chart after DOM update
                setTimeout(() => {
                    createMembershipTrendChart(data.membershipTrend);
                }, 100);
            }
            
            return html;
        }

        // Generate clubs report preview
        function generateClubsReportPreview(report) {
            // Ensure report data exists and is an object
            const data = (report && report.data && typeof report.data === 'object') ? report.data : {};
            
            let html = `
                <h4>Clubs Summary</h4>
                <p>Total Clubs: ${data.totalClubs || 0}</p>
                <p>New Clubs: ${data.newClubs || 0}</p>
                <p>Active Clubs: ${data.activeClubs || 0}</p>
                <p>Inactive Clubs: ${data.inactiveClubs || 0}</p>
            `;
            
            // Add more data as needed
            if (data.clubsByCategory && typeof data.clubsByCategory === 'object' && Object.keys(data.clubsByCategory).length > 0) {
                html += `
                    <h4>Clubs by Category</h4>
                    <div class="report-chart-container">
                        <canvas id="clubsByCategoryChart"></canvas>
                    </div>
                `;
                
                // Create chart after DOM update
                setTimeout(() => {
                    createClubsByCategoryChart(data.clubsByCategory);
                }, 100);
            }
            
            return html;
        }

        // Generate events report preview
        function generateEventsReportPreview(report) {
            // Ensure report data exists and is an object
            const data = (report && report.data && typeof report.data === 'object') ? report.data : {};
            
            let html = `
                <h4>Events Summary</h4>
                <p>Total Events: ${data.totalEvents || 0}</p>
                <p>Upcoming Events: ${data.upcomingEvents || 0}</p>
                <p>Completed Events: ${data.completedEvents || 0}</p>
                <p>Average Attendance: ${data.averageAttendance || 0}</p>
            `;
            
            // Check if eventsByType exists and is an object
            if (data.eventsByType && typeof data.eventsByType === 'object' && Object.keys(data.eventsByType).length > 0) {
                html += `
                    <h4>Events by Type</h4>
                    <div class="report-chart-container">
                        <canvas id="eventsByTypeChart"></canvas>
                    </div>
                `;
                
                // Create chart after DOM update
                setTimeout(() => {
                    createEventsByTypeChart(data.eventsByType);
                }, 100);
            }
            
            // Check if eventAttendance exists and is an array
            if (data.eventAttendance && Array.isArray(data.eventAttendance) && data.eventAttendance.length > 0) {
                html += `
                    <h4>Event Attendance</h4>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Event Name</th>
                                <th>Date</th>
                                <th>Attendance</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.eventAttendance.forEach(event => {
                    const eventDate = new Date(event.date).toLocaleDateString();
                    html += `
                        <tr>
                            <td>${event.name || 'Unknown Event'}</td>
                            <td>${eventDate}</td>
                            <td>${event.attendance || 0}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            return html;
        }

        // Generate financial report preview (now mapped to activity type)
        function generateFinancialReportPreview(report) {
            // Ensure report data exists and is an object
            const data = (report && report.data && typeof report.data === 'object') ? report.data : {};
            
            let html = `
                <h4>Financial Summary</h4>
                <p>Total Income: $${data.totalIncome || 0}</p>
                <p>Total Expenses: $${data.totalExpenses || 0}</p>
                <p>Net Balance: $${data.netBalance || 0}</p>
            `;
            
            // Check if incomeBySource exists and is an object
            if (data.incomeBySource && typeof data.incomeBySource === 'object' && Object.keys(data.incomeBySource).length > 0) {
                html += `
                    <h4>Income by Source</h4>
                    <div class="report-chart-container">
                        <canvas id="incomeBySourceChart"></canvas>
                    </div>
                `;
                
                // Create chart after DOM update
                setTimeout(() => {
                    createIncomeBySourceChart(data.incomeBySource);
                }, 100);
            }
            
            // Check if expensesByCategory exists and is an object
            if (data.expensesByCategory && typeof data.expensesByCategory === 'object' && Object.keys(data.expensesByCategory).length > 0) {
                html += `
                    <h4>Expenses by Category</h4>
                    <div class="report-chart-container">
                        <canvas id="expensesByCategoryChart"></canvas>
                    </div>
                `;
                
                // Create chart after DOM update
                setTimeout(() => {
                    createExpensesByCategoryChart(data.expensesByCategory);
                }, 100);
            }
            
            return html;
        }

        // Generate attendance report preview
        function generateAttendanceReportPreview(report) {
            // Ensure report data exists and is an object
            const data = (report && report.data && typeof report.data === 'object') ? report.data : {};
            
            let html = `
                <h4>Attendance Summary</h4>
                <p>Total Events: ${data.totalEvents || 0}</p>
                <p>Average Attendance Rate: ${data.averageAttendanceRate || 0}%</p>
                <p>Most Active Member: ${data.mostActiveMember || 'N/A'}</p>
            `;
            
            // Check if attendanceByEvent exists and is an array
            if (data.attendanceByEvent && Array.isArray(data.attendanceByEvent) && data.attendanceByEvent.length > 0) {
                html += `
                    <h4>Attendance by Event</h4>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Event Name</th>
                                <th>Date</th>
                                <th>Attendance Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.attendanceByEvent.forEach(event => {
                    const eventDate = new Date(event.date).toLocaleDateString();
                    html += `
                        <tr>
                            <td>${event.name || 'Unknown Event'}</td>
                            <td>${eventDate}</td>
                            <td>${event.attendanceRate || 0}%</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            // Check if topMembers exists and is an array
            if (data.topMembers && Array.isArray(data.topMembers) && data.topMembers.length > 0) {
                html += `
                    <h4>Top Members by Attendance</h4>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Member Name</th>
                                <th>Events Attended</th>
                                <th>Attendance Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.topMembers.forEach(member => {
                    html += `
                        <tr>
                            <td>${member.name || 'Unknown Member'}</td>
                            <td>${member.eventsAttended || 0}</td>
                            <td>${member.attendanceRate || 0}%</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            return html;
        }

        // Create members by role chart
        function createMembersByRoleChart(data) {
            const ctx = document.getElementById('membersByRoleChart');
            if (!ctx || !data || typeof data !== 'object') return;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#003366',
                            '#ffc107',
                            '#28a745',
                            '#dc3545',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Create clubs by category chart
        function createClubsByCategoryChart(data) {
            const ctx = document.getElementById('clubsByCategoryChart');
            if (!ctx || !data || typeof data !== 'object') return;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#003366',
                            '#ffc107',
                            '#28a745',
                            '#dc3545',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Create membership trend chart
        function createMembershipTrendChart(data) {
            const ctx = document.getElementById('membershipTrendChart');
            if (!ctx || !data || !Array.isArray(data)) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.month || 'Unknown'),
                    datasets: [{
                        label: 'Total Members',
                        data: data.map(item => item.count || 0),
                        borderColor: '#003366',
                        backgroundColor: 'rgba(0, 51, 102, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Create events by type chart
        function createEventsByTypeChart(data) {
            const ctx = document.getElementById('eventsByTypeChart');
            if (!ctx || !data || typeof data !== 'object') return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Number of Events',
                        data: Object.values(data),
                        backgroundColor: '#003366'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Create income by source chart
        function createIncomeBySourceChart(data) {
            const ctx = document.getElementById('incomeBySourceChart');
            if (!ctx || !data || typeof data !== 'object') return;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#003366',
                            '#ffc107',
                            '#28a745',
                            '#dc3545',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Create expenses by category chart
        function createExpensesByCategoryChart(data) {
            const ctx = document.getElementById('expensesByCategoryChart');
            if (!ctx || !data || typeof data !== 'object') return;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#dc3545',
                            '#ffc107',
                            '#003366',
                            '#28a745',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Download report
        function downloadReport(reportId) {
            if (!reportId && currentReport) {
                reportId = currentReport._id;
            }
            
            if (!reportId) {
                showError('No report selected for download');
                return;
            }
            
            // Find the report in the allReports array to get its collection
            const report = allReports.find(r => r._id === reportId);
            if (!report) {
                showError('Report not found');
                return;
            }

            // Check if it's an uploaded report (has attachments) OR if it's in the reports collection
            if (report.attachments && report.attachments.length > 0) {
                // Download attachment for uploaded reports
                downloadAttachment(reportId);
                return;
            }

            // For generated reports (in clubactivityreports) without attachments, use the download endpoint for that collection
            let endpoint;
            if (report.collection === 'clubactivityreports') {
                endpoint = `${API_URL}/clubactivityreports/${reportId}/download`;
            } else {
                endpoint = `${API_URL}/reports/${reportId}/download`;
            }

            window.location.href = `${endpoint}?token=${localStorage.getItem('token')}`;
        }

        // Close report preview
        function closeReportPreview() {
            document.getElementById('reportPreviewSection').style.display = 'none';
            currentReport = null;
        }

        // Setup mobile menu toggle
        function setupMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                // Close sidebar when clicking on a link
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        sidebar.classList.remove('active');
                    });
                });
            }
        }

        // Confirm delete report
        function confirmDeleteReport(reportId) {
            // Find the report to get its name for the confirmation dialog
            const report = allReports.find(r => r._id === reportId);
            const reportName = report ? (report.title || report.name || 'this report') : 'this report';
            
            // Create confirmation dialog
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
                <div class="confirm-dialog-content">
                    <div class="confirm-dialog-header">
                        <h3 class="confirm-dialog-title">Confirm Deletion</h3>
                    </div>
                    <div class="confirm-dialog-body">
                        <p>Are you sure you want to delete "${reportName}"? This action cannot be undone.</p>
                    </div>
                    <div class="confirm-dialog-footer">
                        <button class="btn btn-secondary" onclick="closeConfirmDialog()">Cancel</button>
                        <button class="btn btn-danger" onclick="deleteReport('${reportId}')">Delete</button>
                    </div>
                </div>
            `;
            
            // Add dialog to body
            document.body.appendChild(dialog);
        }

        // Close confirmation dialog
        function closeConfirmDialog() {
            const dialog = document.querySelector('.confirm-dialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
        }

        // Delete report
        async function deleteReport(reportId) {
            try {
                showLoading(true);
                
                // Find the report in the allReports array to get its collection
                const report = allReports.find(r => r._id === reportId);
                if (!report) {
                    throw new Error('Report not found in local array');
                }

                // Determine the endpoint based on the collection
                let endpoint;
                let collection;
                
                // Check if the report has attachments - it's likely a ClubActivityReport
                if (report.attachments && report.attachments.length > 0) {
                    endpoint = `${API_URL}/clubactivityreports/${reportId}`;
                    collection = 'clubactivityreports';
                } else {
                    // If no attachments, check the type to determine the collection
                    if (report.type === 'event' || report.type === 'monthly' || report.type === 'annual' || report.type === 'financial') {
                        endpoint = `${API_URL}/clubactivityreports/${reportId}`;
                        collection = 'clubactivityreports';
                    } else {
                        endpoint = `${API_URL}/reports/${reportId}`;
                        collection = 'reports';
                    }
                }
                
                console.log(`Deleting report with ID: ${reportId}`);
                console.log(`Report collection: ${collection}`);
                console.log(`Endpoint: ${endpoint}`);
                
                // Send DELETE request
                const response = await axios.delete(endpoint);
                
                // Remove the report from the allReports array
                allReports = allReports.filter(r => r._id !== reportId);
                
                // Update filtered reports
                filteredReports = filteredReports.filter(r => r._id !== reportId);
                
                // Re-render reports
                if (currentView === 'grid') {
                    renderReportsGrid();
                } else {
                    renderReportsList();
                }
                
                // Show success message
                showSuccess('Report deleted successfully!');
                
                // Close confirmation dialog
                closeConfirmDialog();
                
            } catch (error) {
                console.error('Error deleting report:', error);
                
                // Provide more specific error message
                let errorMessage = 'Failed to delete report. Please try again.';
                
                if (error.response) {
                    console.error('Error response data:', error.response.data);
                    console.error('Error response status:', error.response.status);
                    
                    if (error.response.status === 404) {
                        errorMessage = 'Report not found. It may have been already deleted.';
                    } else if (error.response.data && error.response.data.message) {
                        errorMessage = error.response.data.message;
                    }
                } else if (error.request) {
                    console.error('Error request:', error.request);
                    errorMessage = 'No response from server. Please check your internet connection.';
                } else {
                    console.error('Error message:', error.message);
                    errorMessage = `Error: ${error.message}`;
                }
                
                showError(errorMessage);
            } finally {
                showLoading(false);
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    </script>
</body>
</html>